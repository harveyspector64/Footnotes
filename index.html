import React, { useState, useRef, useEffect } from "react";
import { Canvas, useFrame } from "@react-three/fiber";
import { OrbitControls } from "@react-three/drei";
import { motion, AnimatePresence } from "framer-motion";

/**
 * -----------------------------------------------------------------------------
 *  FOOTNOTES OF CREATION ▸ single-file demo (React + Tailwind + react-three-fiber)
 * -----------------------------------------------------------------------------
 *  – Minimal, production-ready scaffold that demonstrates overall IA + visuals
 *  – Uses three-js shader plane for subtle background movement
 *  – Responsive archive grid → modal viewer with video + rich text + footnotes
 *  – Designed to live at /src/App.jsx in a Vite or Next.js setup (just add data)
 *  – Tailwind styles assume the color palette in :root css variables matches
 *    user’s design system (void-black, aged-parchment, etc.)
 * -------------------------------------------------------------------------- */

/* ------------------------------------------------- 1. Demo data -------------*/
//  Replace/thumb/video URLs w/ real assets; `text` can hold full chapter markup.
const chapters = [
  {
    id: 1,
    title: `In the Before, which is to say the Never-Quite-But-Almost`,
    snippet: `There roll’d a sort of Clamor, a Cosmic Mutter ...`,
    image: "/assets/ch1-thumb.jpg",
    video: "/assets/ch1.mp4",
    text: `

${`In the Before, which is to say ...`} `,
  },
  // ...push remaining chapters here
];

/* ----------------------------- 2. GLSL background plane --------------------*/
function BackgroundPlane() {
  const mesh = useRef();
  useFrame(({ clock }) => {
    mesh.current.material.uniforms.time.value = clock.getElapsedTime();
  });
  return (
    <mesh ref={mesh} rotation={[-Math.PI / 2, 0, 0]} position={[0, 0, -2]}>
      <planeGeometry args={[100, 100, 128, 128]} />
      <shaderMaterial
        uniforms={{ time: { value: 0 } }}
        vertexShader={`
          uniform float time;
          void main() {
            vec3 p = position;
            p.z += sin(p.x * 4.0 + time * 0.7) * 0.12;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(p, 1.0);
          }
        `}
        fragmentShader={`
          void main() {
            gl_FragColor = vec4(0.05, 0.05, 0.10, 0.82);
          }
        `}
        transparent
      />
    </mesh>
  );
}

/* ----------------------------- 3. Footnote helper --------------------------*/
//  Converts [[footnote text]] patterns → superscript tooltips.
function FootnoteRender({ raw }) {
  return raw.split(/\[\[(.*?)\]\]/g).map((chunk, i) =>
    i % 2 ? (
      <sup key={i} className="relative cursor-help group">
        {i / 2}
        <span className="absolute bottom-full mb-2 w-max max-w-xs px-3 py-2 text-xs bg-deep-moss text-aged-parchment rounded opacity-0 group-hover:opacity-100 transition">
          {chunk}
        </span>
      </sup>
    ) : (
      <span key={i} dangerouslySetInnerHTML={{ __html: chunk }} />
    ),
  );
}

/* ----------------------------- 4. Main component ---------------------------*/
export default function FootnotesOfCreationSite() {
  const [open, setOpen] = useState(null);

  // Disable body scroll while modal open
  useEffect(() => {
    document.body.style.overflow = open ? "hidden" : "auto";
  }, [open]);

  return (
    <div className="min-h-screen bg-void-black text-aged-parchment font-sans selection:bg-corrupted-blue/50">
      {/* WebGL canvas backdrop */}
      <Canvas className="fixed inset-0 -z-20" camera={{ position: [0, 0, 10] }}>
        <ambientLight intensity={0.5} />
        <BackgroundPlane />
        <OrbitControls enableZoom={false} enablePan={false} enableRotate={false} />
      </Canvas>

      {/*  Header  */}
      <header className="relative px-6 md:px-16 py-24 lg:py-32">
        <h1 className="font-serif text-4xl md:text-6xl lg:text-7xl leading-tight tracking-wide">
          Footnotes of Creation
        </h1>
        <p className="mt-6 max-w-xl text-lg md:text-xl opacity-80">
          An Unearthed Archive of Genesis, bureaucracy, and cosmic mischief.
        </p>
      </header>

      {/* Archive grid */}
      <main className="relative px-6 md:px-16 pb-32">
        <section className="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {chapters.map((c) => (
            <motion.article
              key={c.id}
              whileHover={{ translateY: -6 }}
              transition={{ type: "spring", stiffness: 220, damping: 25 }}
              className="cursor-pointer group"
              onClick={() => setOpen(c)}
            >
              <div className="aspect-video overflow-hidden rounded-2xl shadow-xl">
                <img
                  src={c.image}
                  alt={c.title}
                  className="object-cover w-full h-full transition-transform duration-700 group-hover:scale-105"
                />
              </div>
              <h2 className="mt-4 font-serif text-xl leading-snug group-hover:underline">
                {c.title}
              </h2>
              <p className="mt-2 text-sm leading-relaxed opacity-70">{c.snippet}</p>
            </motion.article>
          ))}
        </section>
      </main>

      {/*  Modal viewer  */}
      <AnimatePresence>
        {open && (
          <motion.div
            className="fixed inset-0 z-40 flex items-center justify-center bg-black/70 backdrop-blur-xl"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={() => setOpen(null)}
          >
            <motion.div
              className="relative max-w-5xl w-[90%] bg-void-black rounded-3xl overflow-hidden shadow-2xl"
              initial={{ scale: 0.95 }}
              animate={{ scale: 1 }}
              exit={{ scale: 0.95 }}
              onClick={(e) => e.stopPropagation()}
            >
              <video
                src={open.video}
                autoPlay
                loop
                controls
                className="w-full aspect-video object-cover"
              />
              <div className="p-8 overflow-y-auto max-h-[60vh] prose prose-invert">
                <FootnoteRender raw={open.text} />
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Footer */}
      <footer className="relative px-6 md:px-16 py-12 text-xs opacity-60">
        © {new Date().getFullYear()} Footnotes of Creation — All Rights Reserved.
      </footer>
    </div>
  );
}
